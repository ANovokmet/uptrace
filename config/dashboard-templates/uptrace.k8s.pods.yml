schema: v2
name: 'K8s: Pods'
force: true

table:
  grid_items:
    - title: Running pods
      description: Number of pods
      type: gauge
      template: ${num_running} of ${num_all}
      metrics:
        - k8s.pod.phase as $phase
      query:
        - uniq($phase{_value=2}, k8s.pod.name) as num_running
        - uniq($phase, k8s.pod.name) as num_all

    - title: Total RSS
      description: RSS usage on all pods
      type: gauge
      metrics:
        - k8s.pod.memory.rss as $rss
      query:
        - last(sum($rss))
      columns:
        sum($rss):
          unit: bytes

    - title: Total FS
      description: Total filesystem usage on all nodes
      type: gauge
      metrics:
        - k8s.pod.filesystem.usage as $usage
      query:
        - last(sum($usage))
      columns:
        sum($usage):
          unit: bytes

  metrics:
    - k8s.pod.memory.rss as $rss_mem
    - k8s.pod.memory.usage as $mem_usage
    - k8s.pod.cpu.utilization as $cpu_util
    - k8s.pod.filesystem.usage as $fs_usage
    - k8s.pod.filesystem.capacity as $fs_capacity
  query:
    - group by k8s.namespace.name
    - group by k8s.pod.name
    - $cpu_util
    - $mem_usage
    - $rss_mem
    - $fs_usage
    - $fs_usage / $fs_capacity as fs_util
  columns:
    cpu_util:
      unit: utilization
    fs_usage:
      unit: bytes
    fs_util:
      unit: utilization
    mem_usage:
      unit: bytes
    rss_mem:
      unit: bytes

grid_rows:
  - title: Gauges
    items:
      - title: Running pods
        description: Number of pods
        type: gauge
        template: ${num_running} of ${num_all}
        metrics:
          - k8s.pod.phase as $phase
        query:
          - uniq($phase{_value=2}, k8s.pod.name) as num_running
          - uniq($phase, k8s.pod.name) as num_all

      - title: Total RSS
        description: RSS usage on all pods
        type: gauge
        metrics:
          - k8s.pod.memory.rss as $rss
        query:
          - last(sum($rss))
        columns:
          sum($rss):
            unit: bytes

      - title: Total FS
        description: Total filesystem usage on all nodes
        type: gauge
        metrics:
          - k8s.pod.filesystem.usage as $usage
        query:
          - last(sum($usage))
        columns:
          sum($usage):
            unit: bytes

  - title: General
    items:
      - title: CPU utilization
        metrics:
          - k8s.pod.cpu.utilization as $utilization
        query:
          - $utilization
        columns:
          utilization:
            unit: utilization

      - title: RSS memory
        metrics:
          - k8s.pod.memory.rss as $rss
        query:
          - $rss
        columns:
          rss:
            unit: bytes

      - title: RAM usage
        metrics:
          - k8s.pod.memory.usage as $usage
        query:
          - $usage
        columns:
          usage:
            unit: bytes

      - title: Memory working set
        metrics:
          - k8s.pod.memory.working_set as $working_set
        query:
          - $working_set
        columns:
          working_set:
            unit: bytes

      - title: Memory major page faults
        metrics:
          - k8s.pod.memory.major_page_faults as $major_page_faults
        query:
          - $major_page_faults

      - title: Memory page faults
        metrics:
          - k8s.pod.memory.page_faults as $page_faults
        query:
          - delta($page_faults)
        columns:
          delta($page_faults):
            color: '#5470c6'
        legend:
          type: list
          placement: bottom
          values:
            - avg

      - title: Filesystem available
        metrics:
          - k8s.pod.filesystem.available as $available
        query:
          - $available
        columns:
          available:
            unit: bytes

      - title: Filesystem usage
        metrics:
          - k8s.pod.filesystem.usage as $usage
        query:
          - $usage
        columns:
          usage:
            unit: bytes
