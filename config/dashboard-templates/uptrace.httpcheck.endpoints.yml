# https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/receiver/httpcheckreceiver/metadata.yaml

schema: v2
name: 'HTTP Check endpoints'
force_update: true

table:
  grid_items:
    - title: Successful checks
      description: Number of successful check out of all check
      type: gauge
      template: ${num_up} out of ${num_all}
      metrics:
        - httpcheck.status as $status
      query:
        - uniq($status{http.response.status_class="2xx"}) as num_all
        - uniq($status{http.response.status_class="2xx", _value=1}) as num_up

  metrics:
    - httpcheck.status as $status
    - httpcheck.duration as $duration
  query:
    - group by url.full
    - group by host.name
    - min($status{http.response.status_class="2xx"})
    - avg($duration)

grid_rows:
  - title: Gauges
    items:
      - title: Status
        description: HTTP check status
        type: gauge
        metrics:
          - httpcheck.status as $status
        query:
          - $status{http.response.status_class="2xx"}
        value_mappings:
          - op: gte
            value: 1
            text: UP
            color: green
          - op: eq
            value: 0
            text: DOWN
            color: red
          - op: any
            text: UNKNOWN
            color: gray

  - title: General
    items:
      - title: HTTP check result
        metrics:
          - httpcheck.status as $status
        query:
          - $status
          - group by http.response.status_code

      - title: HTTP check duration
        metrics:
          - httpcheck.duration as $duration
        query:
          - $duration

      - title: HTTP check by host
        width: 6
        height: 21
        yAxis: 15
        type: table
        metrics:
          - httpcheck.status as $status
        query:
          - $status
          - group by host.name

monitors:
  - name: HTTP check is down
    metrics:
      - httpcheck.status as $status
    query:
      - group by url.full
      - group by host.name
      - $status{http.response.status_class="2xx"} as status_2xx
    column: status_2xx
    min_allowed_value: 1
    max_allowed_value: 1
    check_num_point: 1
    null_points: allow
