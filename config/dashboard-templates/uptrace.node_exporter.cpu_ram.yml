schema: v2
name: 'Node exporter: CPU & RAM'

table:
  metrics:
    - node_memory_MemFree_bytes as $mem_free
    - node_cpu_seconds_total as $cpu_secs
    - node_memory_SwapFree_bytes as $swap_free
    - node_memory_SwapTotal_bytes as $swap_total
  query:
    - group by instance
    - group by job
    - sum(irate($cpu_secs{mode!="idle"} by (cpu, mode))) / sum(irate($cpu_secs by (cpu, mode))) as
      cpu_util
    - $mem_free
    - $swap_total - $swap_free as swap_used
  columns:
    cpu_util:
      unit: utilization
      agg_func: last
    mem_free:
      unit: bytes
      agg_func: last
    swap_used:
      unit: bytes
      agg_func: last

grid_rows:
  - title: Gauges
    items:
      - title: CPU busy
        type: gauge
        metrics:
          - node_cpu_seconds_total as $cpu_secs
        query:
          - sum(irate($cpu_secs{mode!="idle"} by (cpu, mode))) / sum(irate($cpu_secs by (cpu,
            mode))) as cpu_util
        columns:
          cpu_util:
            unit: utilization
            agg_func: last

      - title: 5m sys load
        type: gauge
        metrics:
          - node_load5 as $load5
          - node_cpu_seconds_total as $cpu_secs
        query:
          - avg($load5) / sum(irate($cpu_secs by (cpu, mode)))
        columns:
          avg($load5) / sum(irate($cpu_secs)):
            unit: utilization
            agg_func: last

      - title: 15m sys load
        type: gauge
        metrics:
          - node_load15 as $load
          - node_cpu_seconds_total as $cpu_secs
        query:
          - avg($load) / sum(irate($cpu_secs by (cpu, mode)))
        columns:
          avg($load) / sum(irate($cpu_secs)):
            unit: utilization
            agg_func: last

      - title: RAM
        type: gauge
        metrics:
          - node_memory_MemTotal_bytes as $total
        query:
          - $total
        columns:
          total:
            unit: bytes
            agg_func: last

      - title: RAM used
        type: gauge
        metrics:
          - node_memory_MemTotal_bytes as $total
          - node_memory_MemFree_bytes as $free
        query:
          - ($total - $free) / $total as ram_util
        columns:
          ram_util:
            unit: utilization
            agg_func: last

      - title: Root FS used
        type: gauge
        metrics:
          - node_filesystem_avail_bytes as $avail_bytes
          - node_filesystem_size_bytes as $size_bytes
        query:
          - 1 - $avail_bytes{mountpoint="/",fstype!="rootfs"} /
            $size_bytes{mountpoint="/",fstype!="rootfs"} as fs_used
        columns:
          fs_used:
            unit: utilization
            agg_func: last

      - title: Uptime
        type: gauge
        metrics:
          - node_time_seconds as $node_time
          - node_boot_time_seconds as $boot_time
        query:
          - $node_time - $boot_time as uptime
        columns:
          uptime:
            unit: seconds
            agg_func: last

  - title: Row title
    items:
      - title: CPU utilization
        metrics:
          - node_cpu_seconds_total as $cpu_secs
        query:
          - sum(irate($cpu_secs{mode!="idle"} by (cpu, mode))) / sum(irate($cpu_secs by (cpu,
            mode))) as cpu_util
        columns:
          cpu_util:
            unit: utilization

      - title: CPU by mode
        chart: stacked-area
        metrics:
          - node_cpu_seconds_total as $cpu_secs
        query:
          - sum(irate($cpu_secs by (cpu, mode)) by (mode)) / sum(irate($cpu_secs by (cpu, mode))) as
            cpu_util
        columns:
          cpu_util:
            unit: utilization

      - title: RAM free
        metrics:
          - node_memory_MemFree_bytes as $mem_free
        query:
          - $mem_free
        columns:
          mem_free:
            unit: bytes

      - title: RAM cached + buffer
        chart: area
        metrics:
          - node_memory_Cached_bytes as $mem_cached
          - node_memory_Buffers_bytes as $mem_buffers
          - node_memory_SReclaimable_bytes as $mem_reclaimable
        query:
          - $mem_cached + $mem_buffers + $mem_reclaimable as mem_cached_buffer
        columns:
          mem_cached_buffer:
            unit: bytes

      - title: Swap used
        chart: area
        metrics:
          - node_memory_SwapTotal_bytes as $swap_total
          - node_memory_SwapFree_bytes as $swap_free
        query:
          - $swap_total - $swap_free as swap_used
        columns:
          swap_used:
            unit: bytes
