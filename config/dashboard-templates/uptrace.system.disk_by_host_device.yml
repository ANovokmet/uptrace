schema: v2
name: 'System: Disk Metrics'

table:
  grid_items:
    - title: Number of disks
      description: Number of disks
      type: gauge
      metrics:
        - system.disk.io as $disk_io
      query:
        - uniq($disk_io, host.name, device) as num_device
        - where device !~ "loop"
      template: ${num_device} devices

    - title: Avg read size
      description: Average read size
      type: gauge
      metrics:
        - system.disk.io as $disk_io
        - system.disk.operations as $ops
      query:
        - $disk_io{direction=read} / $ops{direction=read} as read_size
        - where device !~ "loop"
      columns:
        read_size: { unit: bytes }

    - title: Avg write size
      description: Average write size
      type: gauge
      metrics:
        - system.disk.io as $disk_io
        - system.disk.operations as $ops
      query:
        - $disk_io{direction=write} / $ops{direction=write} as write_size
        - where device !~ "loop"
      columns:
        write_size: { unit: bytes }

    - title: Avg read latency
      description: Average read latency
      type: gauge
      metrics:
        - system.disk.operation_time as $op_time
        - system.disk.operations as $ops
      query:
        - $op_time{direction=read} / $ops{direction=read} as read_latency
        - where device !~ "loop"
      columns:
        read_latency: { unit: seconds }

    - title: Avg write latency
      description: Average write latency
      type: gauge
      metrics:
        - system.disk.operation_time as $op_time
        - system.disk.operations as $ops
      query:
        - $op_time{direction=write} / $ops{direction=write} as write_latency
        - where device !~ "loop"
      columns:
        write_latency: { unit: seconds }

  metrics:
    - system.disk.io as $disk_io
    - system.disk.operations as $ops
    - system.disk.operation_time as $op_time
  query:
    - group by host.name
    - group by device
    - where device !~ "loop"
    - per_min($disk_io{direction=read}) as read_bytes
    - per_min($disk_io{direction=write}) as written_bytes
    - per_min($ops{direction=read}) as reads
    - per_min($ops{direction=write}) as writes
    - $op_time{direction=read} / $ops{direction=read} as read_latency
    - $op_time{direction=write} / $ops{direction=write} as write_latency
  columns:
    reads: { unit: none }
    writes: { unit: none }
    read_latency: { unit: seconds }
    write_latency: { unit: seconds }

grid_rows:
  - title: Gauges
    items:
      - title: Avg read size
        description: Average read size
        type: gauge
        metrics:
          - system.disk.io as $disk_io
          - system.disk.operations as $ops
        query:
          - $disk_io{direction=read} / $ops{direction=read} as read_size
          - where device !~ "loop"
        columns:
          read_size: { unit: bytes }

      - title: Avg write size
        description: Average write size
        type: gauge
        metrics:
          - system.disk.io as $disk_io
          - system.disk.operations as $ops
        query:
          - $disk_io{direction=write} / $ops{direction=write} as write_size
          - where device !~ "loop"
        columns:
          write_size: { unit: bytes }

      - title: Avg read latency
        description: Average read latency
        type: gauge
        metrics:
          - system.disk.operation_time as $op_time
          - system.disk.operations as $ops
        query:
          - $op_time{direction=read} / $ops{direction=read} as read_latency
          - where device !~ "loop"
        columns:
          read_latency: { unit: seconds }

      - title: Avg write latency
        description: Average write latency
        type: gauge
        metrics:
          - system.disk.operation_time as $op_time
          - system.disk.operations as $ops
        query:
          - $op_time{direction=write} / $ops{direction=write} as write_latency
          - where device !~ "loop"
        columns:
          write_latency: { unit: seconds }

  - title: General
    items:
      - title: Disk reads and writes
        metrics:
          - system.disk.io as $disk_io
        query:
          - per_min($disk_io{direction=read}) as reads
          - per_min($disk_io{direction=write}) as writes
        chart: stacked-bar

      - title: Avg read/write latency
        metrics:
          - system.disk.operations as $ops
          - system.disk.operation_time as $op_time
        query:
          - $op_time{direction=read} / $ops{direction=read} as read_latency
          - $op_time{direction=write} / $ops{direction=write} as write_latency
        columns:
          read_latency: { unit: seconds }
          write_latency: { unit: seconds }

      - title: Avg read/write size
        metrics:
          - system.disk.io as $disk_io
          - system.disk.operations as $ops
        query:
          - $disk_io{direction=read} / $ops{direction=read} as read_size
          - $disk_io{direction=write} / $ops{direction=write} as write_size
        columns:
          read_size: { unit: bytes }
          write_size: { unit: bytes }
        chart: stacked-area

      - title: Disk read/write operations
        metrics:
          - system.disk.operations as $ops
        query:
          - per_min($ops{direction=read}) as reads
          - per_min($ops{direction=write}) as writes
        chart: stacked-bar

      - title: Disk pending operations
        metrics:
          - system.disk.pending_operations as $pending_ops
        query:
          - per_min($pending_ops)

      - title: Number of disk reads/writes merged into single physical disk access operations
        metrics:
          - system.disk.merged as $merged
        query:
          - per_min($merged)

      - title: Time disk spent activated
        metrics:
          - system.disk.io_time as $disk_time
        query:
          - per_min($disk_time)

monitors:
  - name: Disk pending operations
    metrics:
      - system.disk.pending_operations as $pending_ops
    query:
      - $pending_ops
      - group by host.name, device
    column: pending_ops
    max_allowed_value: 100
    check_num_point: 10
