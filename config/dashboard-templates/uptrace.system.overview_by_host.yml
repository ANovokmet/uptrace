schema: v2
name: 'System: CPU/RAM/Swap'

table:
  grid_items:
    - title: Number of hosts
      description: Number of host.name
      type: gauge
      metrics:
        - system.memory.usage as $mem_usage
      query:
        - uniq($mem_usage, host.name) as num_host
      template: ${num_host} hosts

    - title: Total RAM
      description: Total RAM across all nodes
      type: gauge
      metrics:
        - system.memory.usage as $mem_usage
      query:
        - $mem_usage

    - title: Free RAM
      description: Free RAM across all nodes
      type: gauge
      metrics:
        - system.memory.usage as $mem_usage
      query:
        - $mem_usage{state=free} as free

    - title: Mem. util
      description: Memory utilization across all nodes
      type: gauge
      metrics:
        - system.memory.usage as $mem_usage
      query:
        - $mem_usage{state!=free} / $mem_usage as mem_util
      columns:
        mem_util: { unit: utilization }

    - title: Avg free RAM
      description: Avg free RAM across all nodes
      type: gauge
      metrics:
        - system.memory.usage as $mem_usage
      query:
        - avg($mem_usage{state=free}) as free

  metrics:
    - system.cpu.load_average.15m as $load_avg_15m
    - system.cpu.time as $cpu_time
    - system.memory.usage as $mem_usage
  query:
    - group by host.name
    - $load_avg_15m / uniq($cpu_time, cpu) as cpu_util
    - $cpu_time{state=idle} / $cpu_time as cpu_idle_time
    - $cpu_time{state=wait} / $cpu_time as cpu_wait_time
    - $mem_usage{state!=free} / $mem_usage as mem_util
    - $mem_usage{state=used} as mem_used
  columns:
    cpu_util: { unit: utilization }
    cpu_idle_time: { unit: utilization }
    cpu_wait_time: { unit: utilization }
    mem_util: { unit: utilization }
    swap_util: { unit: utilization }
    mem_used: { unit: bytes }

grid_rows:
  - title: General
    items:
      - title: CPU 1 minute load average
        metrics:
          - system.cpu.load_average.1m as $load_avg_1m
          - system.cpu.time as $cpu_time
        query:
          - $load_avg_1m
          - $load_avg_1m / uniq($cpu_time, cpu) as cpu_util
        columns:
          cpu_util: { unit: utilization }

      - title: CPU 5 minute load average
        metrics:
          - system.cpu.load_average.5m as $load_avg_5m
          - system.cpu.time as $cpu_time
        query:
          - $load_avg_5m
          - $load_avg_5m / uniq($cpu_time, cpu) as cpu_util
        columns:
          cpu_util: { unit: utilization }

      - title: CPU 15 minute load average
        metrics:
          - system.cpu.load_average.15m as $load_avg_15m
          - system.cpu.time as $cpu_time
        query:
          - $load_avg_15m
          - $load_avg_15m / uniq($cpu_time, cpu) as cpu_util
        columns:
          cpu_util: { unit: utilization }

      - title: CPU time
        metrics:
          - system.cpu.time as $cpu_time
        query:
          - per_min($cpu_time) as cpu_time group by state
        chart: stacked-area

      - title: CPU wait time
        description:
          A wait state is a delay experienced by a computer processor when accessing external memory
          or another device that is slow to respond.
        metrics:
          - system.cpu.time as $cpu_time
        query:
          - $cpu_time{state=wait} / $cpu_time as cpu_wait
        columns:
          cpu_wait: { unit: utilization }

      - title: CPU idle time
        metrics:
          - system.cpu.time as $cpu_time
        query:
          - $cpu_time{state=idle} / $cpu_time as cpu_wait
        columns:
          cpu_wait: { unit: utilization }

      - title: RAM utilization
        metrics:
          - system.memory.usage as $mem_usage
        query:
          - $mem_usage{state!=free} / $mem_usage as mem_util
        columns:
          mem_util: { unit: utilization }

      - title: RAM usage
        metrics:
          - system.memory.usage as $mem_usage
        query:
          - $mem_usage group by state
        columns:
          mem_usage: { unit: bytes }
        chart: stacked-area

      - title: Swap or pagefile utilization
        metrics:
          - system.paging.usage as $paging
        query:
          - $paging{state!=free} / $paging as swap_util
        columns:
          swap_util: { unit: utilization }

      - title: Swap or pagefile usage
        metrics:
          - system.paging.usage as $paging
        query:
          - $paging group by state
        columns:
          paging: { unit: bytes }
        chart: stacked-area

      - title: Number of page operations
        metrics:
          - system.paging.operations as $page_ops
        query:
          - per_min($page_ops) as page_ops group by direction
        chart: stacked-area

      - title: Number of page faults
        metrics:
          - system.paging.faults as $page_faults
        query:
          - per_min($page_faults) as page_faults group by type
        chart: stacked-area

      - title: Network connections
        metrics:
          - system.network.connections as $net_conns
        query:
          - $net_conns

monitors:
  - name: CPU usage
    metrics:
      - system.cpu.load_average.15m as $load_avg_15m
      - system.cpu.time as $cpu_time
    query:
      - $load_avg_15m / uniq($cpu_time, cpu) as cpu_util
      - group by host.name
    column: cpu_util
    column_unit: utilization
    max_allowed_value: 3
    check_num_point: 10
